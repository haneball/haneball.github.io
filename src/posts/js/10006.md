---
lang: zh-CN
title: deepClone 深拷贝
category:
    - JavaScript
tag:
    - 自设方法
order: 6
---

- 使用递归的方式进行深拷贝，支持多种类型
- 拷贝 Function 需要截取 `{...}` 内的函数体
- 设置 map 以记录 obj 是否已经拷贝，避免循环调用时重复拷贝
- 类型为 `symbol` 的键，应当使用 `Object.getOwnPropertySymbols()` 获取

<!-- more -->

```js
function deepClone(obj, map = WeakMap()) {
    // Function 类型
    if (obj instanceof Function) {
        const str = obj.toString()
        const subStr = str.substring(str.indexOf('{') + 1, str.indexOf('}'))

        return new Function(subStr)
    }

    // Date 类型
    if (obj instanceof Date) {
        return new Date(obj.getTime())
    }

    // Set 类型
    if (obj instanceof Set) {
        return new Set([...obj])
    }

    // Map 类型
    if (obj instanceof Map) {
        return new Map([...obj])
    }

    // Symbol 类型
    if (typeof obj === 'symbol') {
        return Symbol(obj.description)
    }

    // 非 object 类型
    if (!obj || typeof obj !== 'object') {
        return obj
    }

    // 已存在对应 obj，直接返回
    if (map.has(obj)) {
        return map.get(obj)
    }

    const newObj = Array.isArray(obj) ? [] : {}
    // 将 newObj 存入 map
    map.set(obj, newObj)

    for (let prop in obj) {
        // 不拷贝原型上的属性
        if (obj.hasOwnProperty(prop)) {
            newObj[prop] = deepClone(obj[prop], map)
        }
    }

    // 类型为 Symbol 的 props
    const symbolProps = Object.getOwnPropertySymbols(obj)

    for (let prop in symbolProps) {
        newObj[prop] = deepClone(obj[prop], map)
    }

    return newObj
}
```
